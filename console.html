<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Console</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background-color: #050505; 
            color: #00ff41; 
            padding: 10px; margin: 0; font-size: 13px;
        }
        h1 { border-bottom: 2px solid #00ff41; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.1rem; }
        .stat-box { margin-bottom: 15px; border: 1px solid #333; padding: 8px; background: #111; }
        
        #log-container { height: 85vh; overflow-y: auto; border: 1px solid #333; background: #000; }
        .log-entry { border-bottom: 1px solid #333; padding: 15px 10px; margin-bottom: 5px; }

        /* HEADER */
        .header-line { margin-bottom: 5px; color: #fff; background: #1a1a1a; padding: 8px; border-left: 3px solid #00ff41; }
        .timestamp { color: #888; display: block; margin-bottom: 2px; font-size: 0.9em; }
        .event-type { font-weight: bold; text-transform: uppercase; float: right; font-size: 0.8em; }

        /* MESSAGE STYLE */
        .msg-content {
            background-color: #222;
            border-left: 4px solid #f60;
            color: #fff;
            padding: 15px;
            font-size: 1.2em;
            margin-top: 5px;
            word-wrap: break-word;
        }

        /* HARDWARE STYLE */
        .data-row { display: flex; flex-direction: column; margin-bottom: 5px; border-bottom: 1px dashed #222; }
        .label { color: #666; font-size: 0.8em; }
        .value { color: #ddd; white-space: pre-wrap; word-break: break-word; }
        
        /* COLORS */
        .col-visit { color: #00ff41; }
        .col-msg { color: #f60; }

    </style>
</head>
<body>

    <h1>// LIVE_FEED</h1>
    <div class="stat-box">EVENTS LOGGED: <span id="visit-count" style="color:#fff">0</span></div>
    <div id="log-container">Awaiting signal...</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyD19FsJIWCif0h-ExcGODrok4M7wk_bSBc",
            authDomain: "void-81e60.firebaseapp.com",
            databaseURL: "https://void-81e60-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "void-81e60",
            storageBucket: "void-81e60.appspot.com",
            messagingSenderId: "749357378719",
            appId: "1:749357378719:web:6343550759a405e5c1c6aa"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const container = document.getElementById('log-container');
        
        db.ref('engagements').on('value', snap => {
            document.getElementById('visit-count').innerText = snap.val() || 0;
        });

        const formatDate = (isoString) => {
            if (!isoString) return 'Unknown Time';
            const d = new Date(isoString);
            const day = d.getDate();
            const suffix = ["th", "st", "nd", "rd"][(day % 10 > 3 || [11, 12, 13].includes(day % 100)) ? 0 : day % 10];
            const month = d.toLocaleString('en-IN', { month: 'short' });
            const year = d.getFullYear();
            const time = d.toLocaleString('en-IN', { hour: 'numeric', minute: 'numeric', hour12: true, timeZone: "Asia/Kolkata" });
            return `${day}${suffix} ${month}. ${year}, ${time}`;
        };

        db.ref('records').limitToLast(50).on('child_added', (snapshot) => {
            if(container.innerHTML.includes('Awaiting')) container.innerHTML = '';

            const data = snapshot.val();
            // Fallback for old data vs new data
            const info = data.fullDeviceInfo || data;
            
            // Determine Type
            let type = "UNKNOWN";
            if (info.type === "VISIT") type = "VISIT";
            else if (info.type === "MESSAGE") type = "MESSAGE";
            else if (info.message) type = "MESSAGE"; // Backward compatibility
            else type = "VISIT"; // Default

            const entry = document.createElement('div');
            entry.className = 'log-entry';

            const timeStr = formatDate(data.timestamp || info.timestamp);
            const ipDisplay = info.ip || info.publicIP || 'Unknown IP';

            // HTML for Header
            let html = `
                <div class="header-line" style="border-left-color: ${type === 'MESSAGE' ? '#f60' : '#00ff41'}">
                    <span class="timestamp">${timeStr}</span>
                    <span class="event-type ${type === 'MESSAGE' ? 'col-msg' : 'col-visit'}">${type}</span>
                    <span style="color:#fff; font-weight:bold;">${ipDisplay}</span>
                </div>
            `;

            // HTML for Content
            if (type === 'MESSAGE') {
                // Just show the message content
                const msgText = info.text || info.message || '[Empty Payload]';
                html += `<div class="msg-content">${msgText}</div>`;
            } else {
                // Show the Hardware Data
                const row = (lbl, val) => `<div class="data-row"><span class="label">${lbl}</span><span class="value">${val || 'N/A'}</span></div>`;
                
                html += `
                    ${row('Device', info.userAgent)}
                    ${row('Platform', info.platform)}
                    ${row('Screen', info.screen)}
                    ${row('Battery', info.battery)}
                    ${row('GPU', info.gpu)}
                    ${row('Connection', info.connection)}
                `;
            }

            entry.innerHTML = html;
            container.insertBefore(entry, container.firstChild);
        });
    });
    </script>
</body>
</html>
